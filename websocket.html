<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>LG TV WebSocket Test Interface (Enhanced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

<script language="javascript" type="text/javascript">

// ===================================================================================
// I. GLOBAL VARIABLES
// ===================================================================================
var output;         // Reference to the log output div element
var clientkey;      // Stores the pairing client key returned by the TV for re-registration
var i = 0;          // Incremental ID for outgoing SSAP requests
var websocket;      // The primary WebSocket object

// ===================================================================================
// II. CORE INITIALIZATION AND CONNECTION LOGIC
// ===================================================================================

/**
 * Initializes the page elements when the window loads.
 */
function init()
{
    output = document.getElementById("output");
    // Set a default IP for convenience
    document.getElementById("ipAddressInput").value = "192.168.222.128"; 
}

/**
 * Constructs the WebSocket URI based on user input and the legacy checkbox state.
 * Supports WSS (secure, port 3001) for modern TVs and WS (insecure, port 3000) for legacy.
 * @returns {string|null} The WebSocket URI or null if IP is missing.
 */
function getWsUri() {
    var ip = document.getElementById("ipAddressInput").value;
    if (!ip) {
        writeToScreen('<span style="color: red;">ERROR:</span> Please enter an IP address.');
        return null;
    }
    
    var isLegacy = document.getElementById("legacyMode").checked;

    // Use WS (insecure) on port 3000 if legacy is checked, otherwise WSS (secure) on port 3001
    var prefix = isLegacy ? "ws://" : "wss://";
    var port = isLegacy ? ":3000" : ":3001";
    
    return prefix + ip + port;
}

/**
 * Attempts a temporary HTTP/HTTPS connection to the TV's port to prompt the user
 * to accept the SSL certificate (if using WSS) or check basic connectivity.
 */
function testHttpConnection() {
    var wsUri = getWsUri();
    if (!wsUri) return;

    var isLegacy = document.getElementById("legacyMode").checked;
    var httpPrefix = isLegacy ? 'http:' : 'https:';
    // Convert the WS/WSS URI to its corresponding HTTP/HTTPS URI
    var httpsUri = wsUri.replace(isLegacy ? 'ws:' : 'wss:', httpPrefix);
    
    // 1. Write instructions to the log immediately
    writeToScreen('<span style="color: orange;">ACTION:</span> <b>PLEASE READ:</b> The new tab will open in 3 seconds to let you see the instructions below.');
    writeToScreen('<span style="color: orange;"><b>IMMEDIATE INSTRUCTION:</b></span> Please switch to the new tab/window when it appears.');
    
    if (isLegacy) {
        writeToScreen('<span style="color: orange;">NOTE:</b> Using <b>HTTP</b> (Port 3000) for connection test.');
    } else {
        writeToScreen('<span style="color: orange;">WHAT TO DO:</b> If you see a <b>security/certificate warning</b>, manually click to <b>accept or proceed</b>.');
    }
    
    writeToScreen('<span style="color: orange;">WHAT TO LOOK FOR:</b> If you see an <b>ERR_CONNECTION_TIMED_OUT</b> error, the IP is wrong or the TV is offline.');
    writeToScreen('<span style="color: orange;">NEXT STEP:</b> <b>Manually close the new tab/window</b> and then return here to click the <b>Connect</b> button.');

    // 2. Schedule the new tab to open after 3 seconds
    setTimeout(function() {
        window.open(httpsUri, '_blank');
        writeToScreen('<span style="color: orange;">STATUS:</span> New tab opened. Please check it now.');
    }, 3000); 
}

/**
 * Initializes the WebSocket connection to the LG TV.
 */
function testWebSocket()
{
    var wsUri = getWsUri();
    if (!wsUri) return;
    
    // Show "Connecting..." message immediately for better UX
    writeToScreen('<span style="color: gray;">STATUS:</span> Attempting to connect...');
    
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
}

/**
 * Closes the existing WebSocket connection.
 */
function closeSocketFunction() {
    if (typeof websocket !== 'undefined') {
        websocket.close();
    }
    i++;
}

// ===================================================================================
// III. WEBSOCKET EVENT HANDLERS
// ===================================================================================

function onOpen(evt)
{
    writeToScreen("CONNECTED");
    // Once connected, the next step is usually registration via getClientKeyFunction()
}

function onClose(evt)
{
    writeToScreen("DISCONNECTED");
}

function onMessage(evt)
{
    var dataJsonFormat = JSON.parse(evt.data);
    // Check if the response contains a client-key (occurs during initial registration)
    if (dataJsonFormat['payload'] && dataJsonFormat['payload']['client-key'] != null) { 
        clientkey = dataJsonFormat['payload']['client-key']; 
        // Note: You should save this 'clientkey' somewhere (e.g., localStorage) for future sessions.
    }
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data +'</span>');
}

function onError(evt)
{
    writeToScreen('<span style="color: red;">ERROR:</span> Connection attempt failed. Check browser console for network or certificate details.');
}

/**
 * Sends a message through the WebSocket.
 * Checks if the socket is open before sending.
 * @param {string} message The JSON string to send to the TV.
 */
function doSend(message)
{
    if (typeof websocket === 'undefined' || websocket.readyState !== WebSocket.OPEN) {
        writeToScreen('<span style="color: red;">ERROR:</span> WebSocket is not open. Please Connect first.');
        return;
    }
    writeToScreen("SENT: " + message);
    websocket.send(message);
}

// ===================================================================================
// IV. SSAP COMMANDS (LG Smart TV API)
// ===================================================================================

// --- Registration Commands ---

/**
 * Sends the initial 'register' request to get the client key.
 * This prompts the TV screen for pairing confirmation.
 * The response will contain the 'client-key' which must be saved.
 */
function getClientKeyFunction() {
    // Standard registration payload asking for a client key
    var hello = "{\"type\":\"register\",\"id\":\"register_0\",\"payload\":{\"forcePairing\":false,\"pairingType\":\"PROMPT\",\"manifest\":{\"manifestVersion\":1,\"appVersion\":\"1.1\",\"signed\":{\"created\":\"20140509\",\"appId\":\"com.lge.test\",\"vendorId\":\"com.lge\",\"localizedAppNames\":{\"\":\"LG Remote App\",\"ko-KR\":\"Î¶¨Î™®Ïª® Ïï±\",\"zxx-XX\":\"–õ–ì R—ç–ºot—ç A–ü–ü\"},\"localizedVendorNames\":{\"\":\"LG Electronics\"},\"permissions\":[\"TEST_SECURE\",\"CONTROL_INPUT_TEXT\",\"CONTROL_MOUSE_AND_KEYBOARD\",\"READ_INSTALLED_APPS\",\"READ_LGE_SDX\",\"READ_NOTIFICATIONS\",\"SEARCH\",\"WRITE_SETTINGS\",\"WRITE_NOTIFICATION_ALERT\",\"CONTROL_POWER\",\"READ_CURRENT_CHANNEL\",\"READ_RUNNING_APPS\",\"READ_UPDATE_INFO\",\"UPDATE_FROM_REMOTE_APP\",\"READ_LGE_TV_INPUT_EVENTS\",\"READ_TV_CURRENT_TIME\"],\"serial\":\"2f930e2d2cfe083771f68e4fe7bb07\"},\"permissions\":[\"LAUNCH\",\"LAUNCH_WEBAPP\",\"APP_TO_APP\",\"CLOSE\",\"TEST_OPEN\",\"TEST_PROTECTED\",\"CONTROL_AUDIO\",\"CONTROL_DISPLAY\",\"CONTROL_INPUT_JOYSTICK\",\"CONTROL_INPUT_MEDIA_RECORDING\",\"CONTROL_INPUT_MEDIA_PLAYBACK\",\"CONTROL_INPUT_TV\",\"CONTROL_POWER\",\"READ_APP_STATUS\",\"READ_CURRENT_CHANNEL\",\"READ_INPUT_DEVICE_LIST\",\"READ_NETWORK_STATE\",\"READ_RUNNING_APPS\",\"READ_TV_CHANNEL_LIST\",\"WRITE_NOTIFICATION_TOAST\",\"READ_POWER_STATE\",\"READ_COUNTRY_INFO\"],\"signatures\":[{\"signatureVersion\":1,\"signature\":\"eyJhbGdvcml0aG0iOiJSU0EtU0hBMjU2Iiwia2V5SWQiOiJ0ZXN0LXNpZ25pbmctY2VydCIsInNpZ25hdHVyZVZlcnNpb24iOjF9.hrVRgjCwXVvE2OOSpDZ58hR+59aFNwYDyjQgKk3auukd7pcegmE2CzPCa0bJ0ZsRAcKkCTJrWo5iDzNhMBWRyaMOv5zWSrthlf7G128qvIlpMT0YNY+n/FaOHE73uLrS/g7swl3/qH/BGFG2Hu4RlL48eb3lLKqTt2xKHdCs6Cd4RMfJPYnzgvI4BNrFUKsjkcu+WD4OO2A27Pq1n50cMchmcaXadJhGrOqH5YmHdOCj5NSHzJYrsW0HPlpuAx/ECMeIZYDh6RMqaFM2DXzdKX9NmmyqzJ3o/0lkk/N97gfVRLW5hA29yeAwaCViZNCP8iC9aO0q9fQojoa7NQnAtw==\"}]}}}";
    doSend(hello);
    i++;
}

/**
 * Sends a 'register' request using the previously obtained (and stored) client key.
 * This bypasses the on-screen pairing prompt.
 */
function verifyClientKeyFunction() {
    if (!clientkey) {
        writeToScreen('<span style="color: red;">ERROR:</span> Client key is not set. Run GetClientKey first.');
        return;
    }
    // Same payload as getClientKey, but with the 'client-key' included
    var hello_w_key = "{\"type\":\"register\",\"id\":\"register_"+i+"\",\"payload\":{\"forcePairing\":false,\"pairingType\":\"PROMPT\",\"client-key\":\""+clientkey+"\",\"manifest\":{\"manifestVersion\":1,\"appVersion\":\"1.1\",\"signed\":{\"created\":\"20140509\",\"appId\":\"com.lge.test\",\"vendorId\":\"com.lge\",\"localizedAppNames\":{\"\":\"LG Remote App\",\"ko-KR\":\"Î¶¨Î™®Ïª® Ïï±\",\"zxx-XX\":\"–õ–ì R—ç–ºot—ç A–ü–ü\"},\"localizedVendorNames\":{\"\":\"LG Electronics\"},\"permissions\":[\"TEST_SECURE\",\"CONTROL_INPUT_TEXT\",\"CONTROL_MOUSE_AND_KEYBOARD\",\"READ_INSTALLED_APPS\",\"READ_LGE_SDX\",\"READ_NOTIFICATIONS\",\"SEARCH\",\"WRITE_SETTINGS\",\"WRITE_NOTIFICATION_ALERT\",\"CONTROL_POWER\",\"READ_CURRENT_CHANNEL\",\"READ_RUNNING_APPS\",\"READ_UPDATE_INFO\",\"UPDATE_FROM_REMOTE_APP\",\"READ_LGE_TV_INPUT_EVENTS\",\"READ_TV_CURRENT_TIME\"],\"serial\":\"2f930e2d2cfe083771f68e4fe7bb07\"},\"permissions\":[\"LAUNCH\",\"LAUNCH_WEBAPP\",\"APP_TO_APP\",\"CLOSE\",\"TEST_OPEN\",\"TEST_PROTECTED\",\"CONTROL_AUDIO\",\"CONTROL_DISPLAY\",\"CONTROL_INPUT_JOYSTICK\",\"CONTROL_INPUT_MEDIA_RECORDING\",\"CONTROL_INPUT_MEDIA_PLAYBACK\",\"CONTROL_INPUT_TV\",\"CONTROL_POWER\",\"READ_APP_STATUS\",\"READ_CURRENT_CHANNEL\",\"READ_INPUT_DEVICE_LIST\",\"READ_NETWORK_STATE\",\"READ_RUNNING_APPS\",\"READ_TV_CHANNEL_LIST\",\"WRITE_NOTIFICATION_TOAST\",\"READ_POWER_STATE\",\"READ_COUNTRY_INFO\"],\"signatures\":[{\"signatureVersion\":1,\"signature\":\"eyJhbGdvcml0aG0iOiJSU0EtU0hBMjU2Iiwia2V5SWQiOiJ0ZXN0LXNpZ25pbmctY2VydCIsInNpZ25hdHVyZVZlcnNpb24iOjF9.hrVRgjCwXVvE2OOSpDZ58hR+59aFNwYDyjQgKk3auukd7pcegmE2CzPCa0bJ0ZsRAcKkCTJrWo5iDzNhMBWRyaMOv5zWSrthlf7G128qvIlpMT0YNY+n/FaOHE73uLrS/g7swl3/qH/BGFG2Hu4RlL48eb3lLKqTt2xKHdCs6Cd4RMfJPYnzgvI4BNrFUKsjkcu+WD4OO2A27Pq1n50cMchmcaXadJhGrOqH5YmHdOCj5NSHzJYrsW0HPlpuAx/ECMeIZYDh6RMqaFM2DXzdKX9NmmyqzJ3o/0lkk/N97gfVRLW5hA29yeAwaCViZNCP8iC9aO0q9fQojoa7NQnAtw==\"}]}}}";
    doSend(hello_w_key);
    i++;
}

// --- Control Commands ---

function turnOffFunction() {
    var testquery = '{"type":"request","id":"' + i +'","uri":"ssap://system/turnOff"}';
    doSend(testquery);
    i++;
}
function getVolume() {
    var testquery = '{"type":"request","id":"status_' + i +'","uri":"ssap://audio/getVolume"}';
    doSend(testquery);
    i++;
}
function setVolume() {
    // Note: You might want to update this to set a specific value, e.g., volume: 10
    var testquery = '{"type":"request","id":"status_' + i +'","uri":"ssap://audio/setVolume","payload":{"volume":0}}';
    doSend(testquery);
    i++;
}
function volumeUp() {
    var testquery = '{"type":"request","id":"volumeup_' + i +'","uri":"ssap://audio/volumeUp"}';
    doSend(testquery);
    i++;
}
function volumeDown() {
    var testquery = '{"type":"request","id":"volumedown_' + i +'","uri":"ssap://audio/volumeDown"}';
    doSend(testquery);
    i++;
}
function toastSendNoti() {
    // Simple toast notification - requires pairing.
    var testquery = '{"type":"request","id":"' + i +'","uri":"ssap://system.notifications/createToast","payload":{"message":"Hello World!"}}';
    doSend(testquery);
    i++;
}
function sendcmd() {
    // Sends the raw command entered by the user in the Command textarea.
    var testquery = document.getElementById("lgtvcmdInput").value;
    doSend(testquery);
    i++;
}


// ===================================================================================
// V. UI UTILITIES (Logging and Copy)
// ===================================================================================

/**
 * Writes a message to the log output and scrolls to the bottom.
 * @param {string} message The HTML formatted message to display.
 */
function writeToScreen(message)
{
    var span = document.createElement("span"); 
    span.style.wordWrap = "break-word";
    span.innerHTML = message;
    output.appendChild(span);
    
    // Ensure the log scrolls to the bottom to show the latest entry
    var logContainer = document.getElementById("logContainer");
    logContainer.scrollTop = logContainer.scrollHeight;
}

/**
 * Copies the content of a specified element (either command input or full log).
 * @param {string} elementId The ID of the element whose content should be copied.
 */
function copyContent(elementId) {
    var contentToCopy;

    if (elementId === "lgtvcmdInput") {
        // Copy the text from the Command textarea
        contentToCopy = document.getElementById(elementId).value;
    } else if (elementId === "output") {
        // Copy the content of all log spans, joined by newlines
        var logEntries = document.getElementById("output").querySelectorAll('#output > span');
        var cleanLogArray = [];
        
        logEntries.forEach(function(span) {
            // Use textContent to exclude any HTML formatting tags (like color spans)
            cleanLogArray.push(span.textContent); 
        });
        
        contentToCopy = cleanLogArray.join('\n');
    } else {
        writeToScreen('<span style="color: red;">ERROR:</span> Invalid copy target ID.');
        return;
    }

    if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API
        navigator.clipboard.writeText(contentToCopy).then(function() {
            writeToScreen('<span style="color: green;">SUCCESS:</span> Content copied to clipboard (' + elementId + ').');
        }).catch(function(err) {
            writeToScreen('<span style="color: red;">ERROR:</span> Failed to copy content: ' + err);
        });
    } else {
        writeToScreen('<span style="color: orange;">WARNING:</span> Clipboard API unavailable. Copy relies on a modern browser environment.');
    }
}

// Attach the initialization function to the window load event
window.addEventListener("load", init, false);

</script>
</head>

<body>

<h2>WebSocket Test</h2>

<form>
    <label for="ipAddressInput">LG TV IP Address (WSS Port 3001 / WS Port 3000):</label><br>
    <input id="ipAddressInput" type="text" placeholder="e.g., 192.168.1.100" style="width: 300px; padding: 10px; margin-bottom: 10px;">
    
    <div style="margin-top: 5px;">
        <input type="checkbox" id="legacyMode">
        <label for="legacyMode">Use **WS/HTTP (Port 3000)** for older LG TVs (Less Secure)</label>
    </div>
</form>

<div id="logContainer">
    <div class="header-with-copy">
        Log Output:
        <span onclick="copyContent('output')" class="copy-button">üìÑ Copy Logs</span>
    </div>
    <div id="output"></div>
</div>

<div id="commandContainer">
    <div class="header-with-copy">
        Command:
        <span onclick="copyContent('lgtvcmdInput')" class="copy-button">üìÑ Copy Command</span>
    </div>
    <textarea id="lgtvcmdInput" type="text" name="LG TV CMD (JSON)"></textarea>
</div>

<div id="buttonContainer">
    <div onclick="testHttpConnection();" id="btn-testhttps" class="button">Test/Accept Certificate</div>
    <div onclick="testWebSocket();" id="btn-connect" class="button">Connect</div>
    <div onclick="closeSocketFunction();" id="btn-disconnect" class="button">Disconnect</div>
    <div onclick="sendcmd();" id="btn-sendcmd" class="button">SendCommand</div>
    <div onclick="getClientKeyFunction();" id="btn-sendcmd" class="button">GetClientKey</div>
    <div onclick="verifyClientKeyFunction();" id="btn-sendcmd" class="button">VerifyClientKey</div>
    <div onclick="turnOffFunction();" id="btn-sendcmd" class="button">TurnOff</div>
    <div onclick="volumeUp();" id="btn-sendcmd" class="button">VolumeUp</div>
    <div onclick="getVolume();" id="btn-sendcmd" class="button">GetVolume</div>
    <div onclick="setVolume();" id="btn-sendcmd" class="button">SetVolume</div>
    <div onclick="volumeDown();" id="btn-sendcmd" class="button">VolumeDown</div>
    <div onclick="toastSendNoti();" id="btn-toastSendNoti" class="button">SendToastNotification</div>
    <div onclick='document.getElementById("output").innerHTML = ""' id="btn-clr" class="button">Clear</div>
</div>

<style>
/* ===================================================================================
// VI. CSS STYLES
// =================================================================================== */

/* FONT AND LAYOUT STYLES */
body {
    width: 90%; /* Center body content */
    margin: 0 auto;
    font-family: Calibri, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.button {
    /* Basic button styling */
    margin: 5px 5px 0 0;
    display: inline-block;
    background: #000;
    padding: 5px 5px; 
    color: #FFF;
    font-size: 15px;
    cursor: pointer;
}
#buttonContainer {
    text-align: center;
    margin-top: 10px;
}

/* --- LOG CONTAINER (Resizing Wrapper and Scroller) --- */
#logContainer {
    width: 100%;
    height: 330px; /* Default height */
    box-sizing: border-box;
    padding: 0; 
    
    resize: both; /* Allows user to resize the container */
    
    /* Configures the container to scroll its content */
    overflow-y: auto; 
    overflow-x: hidden; 
    
    border: 1px solid #ccc; 
    margin-bottom: 15px;
    max-height: 80vh; 
    min-width: 300px; 
}

/* LOG HEADER POSITION FIX */
#logContainer .header-with-copy {
    position: sticky; /* CRITICAL: Pins the header to the top of the scrolling container (#logContainer) */
    top: 0; 
    background-color: #f9f9f9; /* Essential for visibility over scrolling text */
    z-index: 10; 
    padding: 5px 10px; 
    border-bottom: 1px solid #eee; 
    margin: 0;
}

/* #output is the inner log content area */
#output {
    /* Padding applied here ensures log entries are not flush with the border */
    padding: 5px 10px; 
    background-color: #f9f9f9;
}

/* --- COMMAND CONTAINER (Wrapper for Alignment & Resizing) --- */
#commandContainer {
    display: block; 
    width: 100%; 
    box-sizing: border-box;
    padding: 0;
    margin-top: 10px; 
    margin-bottom: 15px; 
    
    /* The container itself gets the border and resizing control, standardizing the appearance */
    border: 1px solid #ccc; 
    resize: both; 
    overflow: auto; 
    min-height: 180px; 
}

/* TEXTAREA ALIGNMENT FIX */
textarea#lgtvcmdInput {
    /* Height is calculated to fill the remaining space in the resizable container (100% minus header height) */
    height: calc(100% - 35px); 
    width: 100%; 
    
    /* CRITICAL FIX: Overrides all browser defaults to ensure alignment */
    display: block; 
    margin: 0; 
    border: none; /* Border is handled by the parent container */
    outline: none; 
    
    /* Padding for the text content inside, which must match the header padding */
    padding: 5px 10px; 
    
    box-sizing: border-box;
    resize: none; /* Disable native textarea resize, relying on parent container resize */
}

/* CSS FOR LOG ENTRIES */
#output span {
    display: block; 
    padding: 3px 0; 
    border-bottom: 1px dotted #ccc; /* Separator for visual clarity */
    line-height: 1.2; 
    white-space: pre-wrap;
    word-break: break-all;
}
#output span:last-child {
    border-bottom: none;
}

/* --- HEADER AND COPY BUTTON STYLES (Used for both Log and Command boxes) --- */
.header-with-copy {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    margin-top: 0; 
}

/* Command header padding must be identical to the textarea's internal padding */
#commandContainer .header-with-copy {
    padding: 5px 10px 5px 10px; 
}

.copy-button {
    font-size: 14px;
    color: #007bff;
    cursor: pointer;
    text-decoration: underline;
    font-weight: normal;
}
.copy-button:hover {
    color: #0056b3;
}
</style>
</body>
</html>
